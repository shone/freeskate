<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>freeskate</title>

		<style>
			html {
				height: 100%;
			}
			body {
				height: 100%;
				margin: 0;
			}
			canvas {
				width:  100%;
				height: 100%;
			}
		</style>
	</head>

	<body>
		<canvas></canvas>
		<script type="importmap">
			{
				"imports": {
					"three": "./three.module.min.js",
					"../utils/BufferGeometryUtils.js": "./BufferGeometryUtils.js",
					"../libs/fflate.module.js": "./fflate.module.js"
				}
			}
		</script>
		<script type="module">
			'use strict';
			import * as THREE from 'three';
			import {OrbitControls} from './OrbitControls.js';
			import {GLTFLoader} from './GLTFLoader.js';
			import {EXRLoader} from './EXRLoader.js';

			const webglRenderer = new THREE.WebGLRenderer({canvas: document.querySelector('canvas')});
			webglRenderer.setClearColor(new THREE.Color(0x191919), 1);
			webglRenderer.setPixelRatio(window.devicePixelRatio);
			webglRenderer.useLegacyLights = false;
			webglRenderer.toneMapping = THREE.ACESFilmicToneMapping;
			webglRenderer.toneMappingExposure = 2;

			const pmremGenerator = new THREE.PMREMGenerator(webglRenderer);
			pmremGenerator.compileEquirectangularShader();
			const exrLoader = new EXRLoader();
			exrLoader.load('skate_park_1k.exr', texture => {
				const envMap = pmremGenerator.fromEquirectangular(texture).texture;
				console.log(envMap, texture);
				pmremGenerator.dispose();
				scene.environment = envMap;
				scene.background = envMap;
				webglRenderer.render(scene, camera)
			});

			const scene = new THREE.Scene();
			const camera = new THREE.PerspectiveCamera(
				60, // FOV
				window.innerWidth / window.innerHeight, // Aspect
				1, // Near
				400, // Far
			);
			camera.position.set(0, 150, 150);
			camera.lookAt(0, 0, 0);

			const light1 = new THREE.AmbientLight(0xFFFFFF, .3);
			light1.name = 'ambient_light';
			camera.add(light1);

			const light2 = new THREE.DirectionalLight(0xFFFFFF, .8 * Math.PI);
			light2.position.set(0.5, 0, 0.866); // ~60ยบ
			light2.name = 'main_light';
			camera.add(light2);

			const gltfLoader = new GLTFLoader();
			const url = 'freeskate.glb';
			gltfLoader.load(url, gltf => {
				scene.add(gltf.scene);
				console.log(`Loaded ${url}:`, gltf.scene);

				const box = new THREE.Box3().setFromObject(gltf.scene);
				const size = box.getSize(new THREE.Vector3()).length();
				const center = box.getCenter(new THREE.Vector3());

				gltf.scene.position.x += (gltf.scene.position.x - center.x);
				gltf.scene.position.y += (gltf.scene.position.y - center.y);
				gltf.scene.position.z += (gltf.scene.position.z - center.z);
				camera.near = size / 100;
				camera.far = size * 100;
				camera.updateProjectionMatrix();

				camera.position.copy(center);
				camera.position.x += size / 2.0;
				camera.position.y += size / 5.0;
				camera.position.z += size / 2.0;
				camera.lookAt(center);

				const orbitControls = new OrbitControls(camera, webglRenderer.domElement);
				orbitControls.maxDistance = size * 10;
				orbitControls.screenSpacePanning = true;
				orbitControls.addEventListener('change', () => webglRenderer.render(scene, camera));

				webglRenderer.render(scene, camera)
			});

			function handleWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				webglRenderer.setSize(window.innerWidth, window.innerHeight);
				webglRenderer.render(scene, camera);
			}
			handleWindowResize();
			window.addEventListener('resize', handleWindowResize);
		</script>
	</body>
</html>
